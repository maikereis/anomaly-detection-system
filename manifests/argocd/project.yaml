apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: ml-system
  namespace: argocd
  # Finalizer para garantir que apps sejam deletados antes do projeto
  finalizers:
    - resources-finalizer.argocd.argoproj.io

spec:
  description: MLOps Anomaly Detection System

  # Repositórios permitidos
  sourceRepos:
    - "*" # Para dev aceita qualquer repo. Em prod, restringir ao repo específico

  # Clusters de destino permitidos
  destinations:
    - namespace: ml-dev
      server: https://kubernetes.default.svc
    - namespace: argocd
      server: https://kubernetes.default.svc
    - namespace: ml-system
      server: https://kubernetes.default.svc
    # Quando criar staging/prod, adicionar:
    # - namespace: ml-staging
    #   server: https://kubernetes.default.svc
    # - namespace: ml-production
    #   server: https://kubernetes.default.svc

  # Tipos de recursos cluster-scoped permitidos (whitelist)
  clusterResourceWhitelist:
    # Recursos fundamentais do Kubernetes
    - group: ""
      kind: Namespace
    - group: "rbac.authorization.k8s.io"
      kind: ClusterRole
    - group: "rbac.authorization.k8s.io"
      kind: ClusterRoleBinding
    - group: "apiextensions.k8s.io"
      kind: CustomResourceDefinition

    # KServe (cluster
    - group: "serving.kserve.io"
      kind: ClusterServingRuntime

  # Recursos namespace-scoped permitidos (whitelist)
  namespaceResourceWhitelist:
    - group: ""
      kind: ConfigMap
    - group: ""
      kind: Secret
    - group: ""
      kind: Service
    - group: ""
      kind: ServiceAccount
    - group: ""
      kind: PersistentVolumeClaim

    # Workloads
    - group: "apps"
      kind: Deployment
    - group: "apps"
      kind: StatefulSet
    - group: "apps"
      kind: DaemonSet
    - group: "batch"
      kind: Job
    - group: "batch"
      kind: CronJob

    # Autoscaling
    - group: "autoscaling"
      kind: HorizontalPodAutoscaler

    # Networking
    - group: "networking.k8s.io"
      kind: Ingress
    - group: "networking.k8s.io"
      kind: NetworkPolicy

    # Monitoring CRDs (namespace-scoped)
    - group: "monitoring.coreos.com"
      kind: ServiceMonitor
    - group: "monitoring.coreos.com"
      kind: PodMonitor
    - group: "monitoring.coreos.com"
      kind: PrometheusRule

    # RBAC (namespace-scoped)
    - group: "rbac.authorization.k8s.io"
      kind: Role
    - group: "rbac.authorization.k8s.io"
      kind: RoleBinding

    # Istio (namespace-scoped)
    - group: "networking.istio.io"
      kind: Gateway
    - group: "networking.istio.io"
      kind: VirtualService
    - group: "networking.istio.io"
      kind: DestinationRule

    # Istio security policies (namespace-scoped)
    - group: "security.istio.io"
      kind: PeerAuthentication
    - group: "security.istio.io"
      kind: RequestAuthentication
    - group: "security.istio.io"
      kind: AuthorizationPolicy

  # Sync windows
  syncWindows:
    - kind: allow
      schedule: "* * * * *" # Permite sync a qualquer momento
      duration: 24h
      applications:
        - "*"
      namespaces:
        - ml-dev

  # Recursos órfãos
  orphanedResources:
    warn: true
