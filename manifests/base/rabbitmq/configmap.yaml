apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
data:
  # Queue definitions for training pipeline
  RABBITMQ_DEFAULT_VHOST: "/"
  
  # Queue names (for reference by other services)
  TRAINING_QUEUE: "training-jobs"
  TRAINING_EVENTS_EXCHANGE: "training-events"
  TRAINING_COMPLETION_QUEUE: "training-completion"
  
  # Connection settings for clients
  RABBITMQ_HOST: "rabbitmq"
  RABBITMQ_PORT: "5672"
  RABBITMQ_MANAGEMENT_PORT: "15672"
  RABBITMQ_VHOST: "ml-training"
  
  definitions.json: |
    {
      "users": [
        {
          "name": "admin",
          "password_hash": "W76Ffe0ti1RQ/lp07VZX6RyvIdwqB57wDG+j4BbzMoHnupVo",
          "hashing_algorithm": "rabbit_password_hashing_sha256",
          "tags": ["administrator"]
        },
        {
          "name": "training",
          "password_hash": "+7dw9qivFhNwf6D/q4+RJu9KSBFS2JpxAdmhy/LphTwEOpMU",
          "hashing_algorithm": "rabbit_password_hashing_sha256",
          "tags": []
        }
      ],
      "vhosts": [
        {"name": "/"},
        {"name": "ml-training"}
      ],
      "permissions": [
        {
          "user": "admin",
          "vhost": "/",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "admin",
          "vhost": "ml-training",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "training",
          "vhost": "ml-training",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        }
      ],
      "exchanges": [
        {
          "name": "training-events",
          "vhost": "ml-training",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "training-dlx",
          "vhost": "ml-training",
          "type": "direct",
          "durable": true,
          "auto_delete": false
        }
      ],
      "queues": [
        {
          "name": "training-jobs",
          "vhost": "ml-training",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "training-dlx",
            "x-dead-letter-routing-key": "training-jobs-dlq"
          }
        },
        {
          "name": "training-jobs-dlq",
          "vhost": "ml-training",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "training-completion",
          "vhost": "ml-training",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "training-priority-high",
          "vhost": "ml-training",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "training-dlx",
            "x-dead-letter-routing-key": "training-jobs-dlq"
          }
        }
      ],
      "bindings": [
        {
          "source": "training-events",
          "vhost": "ml-training",
          "destination": "training-jobs",
          "destination_type": "queue",
          "routing_key": "training.job.standard"
        },
        {
          "source": "training-events",
          "vhost": "ml-training",
          "destination": "training-priority-high",
          "destination_type": "queue",
          "routing_key": "training.job.priority"
        },
        {
          "source": "training-events",
          "vhost": "ml-training",
          "destination": "training-completion",
          "destination_type": "queue",
          "routing_key": "training.completed.*"
        },
        {
          "source": "training-dlx",
          "vhost": "ml-training",
          "destination": "training-jobs-dlq",
          "destination_type": "queue",
          "routing_key": "training-jobs-dlq"
        }
      ]
    }